<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>13 Google Authorization and R | EHA Modeling &amp; Analytics Handbook</title>
  <meta name="description" content="13 Google Authorization and R | EHA Modeling &amp; Analytics Handbook" />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="13 Google Authorization and R | EHA Modeling &amp; Analytics Handbook" />
  <meta property="og:type" content="book" />
  
  
  
  <meta name="github-repo" content="ecohealthalliance/eha-ma-handbook" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="13 Google Authorization and R | EHA Modeling &amp; Analytics Handbook" />
  
  
  




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="favicon.png" type="image/x-icon" />
<link rel="prev" href="12-cloud-computing-services.html"/>
<link rel="next" href="14-encryption.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>
<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
<script type="text/javascript" src="https://aegypti.ecohealthalliance.org:22051/status/dashboard.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="http://www.ecohealthalliance.org" target="_blank"><img src="assets/eha_logo.png" style="max-width: 100%"></a></li>
<li><a href="./" style="text-align:center"><strong>Modeling & Analytics Handbook</strong><a/></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="1" data-path="1-Contributing.html"><a href="1-Contributing.html"><i class="fa fa-check"></i><b>1</b> Contributing</a><ul>
<li class="chapter" data-level="1.1" data-path="1-Contributing.html"><a href="1-Contributing.html#anatomy-of-a-chapter"><i class="fa fa-check"></i><b>1.1</b> Anatomy of a chapter</a></li>
<li class="chapter" data-level="1.2" data-path="1-Contributing.html"><a href="1-Contributing.html#workflow-summary"><i class="fa fa-check"></i><b>1.2</b> Workflow Summary</a><ul>
<li class="chapter" data-level="1.2.1" data-path="1-Contributing.html"><a href="1-Contributing.html#for-quick-edits"><i class="fa fa-check"></i><b>1.2.1</b> For quick edits</a></li>
<li class="chapter" data-level="1.2.2" data-path="1-Contributing.html"><a href="1-Contributing.html#adding-a-chapter"><i class="fa fa-check"></i><b>1.2.2</b> Adding a chapter</a></li>
<li class="chapter" data-level="1.2.3" data-path="1-Contributing.html"><a href="1-Contributing.html#major-edits"><i class="fa fa-check"></i><b>1.2.3</b> Major edits</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="1-Contributing.html"><a href="1-Contributing.html#git-based-workflows"><i class="fa fa-check"></i><b>1.3</b> Git based workflows</a></li>
<li class="chapter" data-level="1.4" data-path="1-Contributing.html"><a href="1-Contributing.html#working-with-rmarkdown-in-the-bookdown-framework"><i class="fa fa-check"></i><b>1.4</b> Working with rmarkdown in the bookdown framework</a></li>
<li class="chapter" data-level="1.5" data-path="1-Contributing.html"><a href="1-Contributing.html#review"><i class="fa fa-check"></i><b>1.5</b> Review</a></li>
<li class="chapter" data-level="1.6" data-path="1-Contributing.html"><a href="1-Contributing.html#modifying-chapters"><i class="fa fa-check"></i><b>1.6</b> Modifying chapters</a></li>
<li class="chapter" data-level="1.7" data-path="1-Contributing.html"><a href="1-Contributing.html#additional-resources"><i class="fa fa-check"></i><b>1.7</b> Additional resources</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="2-quickstart-for-computing.html"><a href="2-quickstart-for-computing.html"><i class="fa fa-check"></i><b>2</b> Quickstart for computing</a><ul>
<li class="chapter" data-level="2.1" data-path="2-quickstart-for-computing.html"><a href="2-quickstart-for-computing.html#optional"><i class="fa fa-check"></i><b>2.1</b> Optional</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="3-projects.html"><a href="3-projects.html"><i class="fa fa-check"></i><b>3</b> Project Management</a><ul>
<li class="chapter" data-level="3.1" data-path="3-projects.html"><a href="3-projects.html#teams-and-work-cycles"><i class="fa fa-check"></i><b>3.1</b> Teams and Work Cycles</a></li>
<li class="chapter" data-level="3.2" data-path="3-projects.html"><a href="3-projects.html#setup-and-materials-organization"><i class="fa fa-check"></i><b>3.2</b> Setup and materials Organization</a><ul>
<li class="chapter" data-level="3.2.1" data-path="3-projects.html"><a href="3-projects.html#code-organization"><i class="fa fa-check"></i><b>3.2.1</b> Code organization</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="4-r.html"><a href="4-r.html"><i class="fa fa-check"></i><b>4</b> R and Reproducible Analysis</a><ul>
<li class="chapter" data-level="4.1" data-path="4-r.html"><a href="4-r.html#install"><i class="fa fa-check"></i><b>4.1</b> Install</a></li>
<li class="chapter" data-level="4.2" data-path="4-r.html"><a href="4-r.html#learn"><i class="fa fa-check"></i><b>4.2</b> Learn</a></li>
<li class="chapter" data-level="4.3" data-path="4-r.html"><a href="4-r.html#additional-resources-1"><i class="fa fa-check"></i><b>4.3</b> Additional Resources</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="5-eha-team-communication.html"><a href="5-eha-team-communication.html"><i class="fa fa-check"></i><b>5</b> EHA Team Communication</a><ul>
<li class="chapter" data-level="5.1" data-path="5-eha-team-communication.html"><a href="5-eha-team-communication.html#install-1"><i class="fa fa-check"></i><b>5.1</b> Install</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="6-documentation-and-outputs.html"><a href="6-documentation-and-outputs.html"><i class="fa fa-check"></i><b>6</b> Documentation and Outputs</a><ul>
<li class="chapter" data-level="6.1" data-path="6-documentation-and-outputs.html"><a href="6-documentation-and-outputs.html#learn-1"><i class="fa fa-check"></i><b>6.1</b> Learn</a></li>
<li class="chapter" data-level="6.2" data-path="6-documentation-and-outputs.html"><a href="6-documentation-and-outputs.html#install-2"><i class="fa fa-check"></i><b>6.2</b> Install</a></li>
<li class="chapter" data-level="6.3" data-path="6-documentation-and-outputs.html"><a href="6-documentation-and-outputs.html#library"><i class="fa fa-check"></i><b>6.3</b> Library</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="7-data-management.html"><a href="7-data-management.html"><i class="fa fa-check"></i><b>7</b> Data Management</a><ul>
<li class="chapter" data-level="7.1" data-path="7-data-management.html"><a href="7-data-management.html#learn-2"><i class="fa fa-check"></i><b>7.1</b> Learn</a></li>
<li class="chapter" data-level="7.2" data-path="7-data-management.html"><a href="7-data-management.html#install-3"><i class="fa fa-check"></i><b>7.2</b> Install</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="8-version-control-git-and-github.html"><a href="8-version-control-git-and-github.html"><i class="fa fa-check"></i><b>8</b> Version Control, Git and Github</a><ul>
<li class="chapter" data-level="8.1" data-path="8-version-control-git-and-github.html"><a href="8-version-control-git-and-github.html#learn-3"><i class="fa fa-check"></i><b>8.1</b> Learn</a></li>
<li class="chapter" data-level="8.2" data-path="8-version-control-git-and-github.html"><a href="8-version-control-git-and-github.html#install-4"><i class="fa fa-check"></i><b>8.2</b> Install</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="9-reviewing-analyses-and-code.html"><a href="9-reviewing-analyses-and-code.html"><i class="fa fa-check"></i><b>9</b> Reviewing Analyses and Code</a><ul>
<li class="chapter" data-level="9.1" data-path="9-reviewing-analyses-and-code.html"><a href="9-reviewing-analyses-and-code.html#learn-4"><i class="fa fa-check"></i><b>9.1</b> Learn</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="10-testing.html"><a href="10-testing.html"><i class="fa fa-check"></i><b>10</b> Testing</a><ul>
<li class="chapter" data-level="10.1" data-path="10-testing.html"><a href="10-testing.html#learn-5"><i class="fa fa-check"></i><b>10.1</b> Learn</a></li>
<li class="chapter" data-level="10.2" data-path="10-testing.html"><a href="10-testing.html#install-5"><i class="fa fa-check"></i><b>10.2</b> Install</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="11-high-performance-servers.html"><a href="11-high-performance-servers.html"><i class="fa fa-check"></i><b>11</b> High-Performance Servers</a></li>
<li class="chapter" data-level="12" data-path="12-cloud-computing-services.html"><a href="12-cloud-computing-services.html"><i class="fa fa-check"></i><b>12</b> Cloud Computing Services</a><ul>
<li class="chapter" data-level="12.1" data-path="12-cloud-computing-services.html"><a href="12-cloud-computing-services.html#setting-up-amazon-credentials"><i class="fa fa-check"></i><b>12.1</b> Setting up Amazon Credentials</a><ul>
<li class="chapter" data-level="12.1.1" data-path="12-cloud-computing-services.html"><a href="12-cloud-computing-services.html#generate-an-access-key"><i class="fa fa-check"></i><b>12.1.1</b> Generate an access key</a></li>
<li class="chapter" data-level="12.1.2" data-path="12-cloud-computing-services.html"><a href="12-cloud-computing-services.html#create-a-credentials-file"><i class="fa fa-check"></i><b>12.1.2</b> Create a credentials file</a></li>
<li class="chapter" data-level="12.1.3" data-path="12-cloud-computing-services.html"><a href="12-cloud-computing-services.html#test-your-key"><i class="fa fa-check"></i><b>12.1.3</b> Test your Key</a></li>
<li class="chapter" data-level="12.1.4" data-path="12-cloud-computing-services.html"><a href="12-cloud-computing-services.html#alternate-credentialing-method"><i class="fa fa-check"></i><b>12.1.4</b> Alternate credentialing method</a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="12-cloud-computing-services.html"><a href="12-cloud-computing-services.html#using-amazon-s3-storage-from-r"><i class="fa fa-check"></i><b>12.2</b> Using Amazon S3 Storage from R</a><ul>
<li class="chapter" data-level="12.2.1" data-path="12-cloud-computing-services.html"><a href="12-cloud-computing-services.html#save-objects-from-s3-to-your-machine"><i class="fa fa-check"></i><b>12.2.1</b> Save objects from S3 to your machine</a></li>
<li class="chapter" data-level="12.2.2" data-path="12-cloud-computing-services.html"><a href="12-cloud-computing-services.html#upload-objects-from-your-machine-to-s3"><i class="fa fa-check"></i><b>12.2.2</b> Upload objects from your machine to S3</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="13-google-authorization-and-r.html"><a href="13-google-authorization-and-r.html"><i class="fa fa-check"></i><b>13</b> Google Authorization and R</a><ul>
<li class="chapter" data-level="13.1" data-path="13-google-authorization-and-r.html"><a href="13-google-authorization-and-r.html#the-basic-overview"><i class="fa fa-check"></i><b>13.1</b> The basic overview:</a></li>
<li class="chapter" data-level="13.2" data-path="13-google-authorization-and-r.html"><a href="13-google-authorization-and-r.html#key-terms"><i class="fa fa-check"></i><b>13.2</b> Key Terms</a></li>
<li class="chapter" data-level="13.3" data-path="13-google-authorization-and-r.html"><a href="13-google-authorization-and-r.html#before-we-start"><i class="fa fa-check"></i><b>13.3</b> Before we start:</a></li>
<li class="chapter" data-level="13.4" data-path="13-google-authorization-and-r.html"><a href="13-google-authorization-and-r.html#setting-up-non-interactive-authentication-for-google-sheets"><i class="fa fa-check"></i><b>13.4</b> Setting up non-interactive authentication for Google sheets</a><ul>
<li class="chapter" data-level="13.4.1" data-path="13-google-authorization-and-r.html"><a href="13-google-authorization-and-r.html#create-a-google-cloud-platform-project"><i class="fa fa-check"></i><b>13.4.1</b> Create a Google cloud platform project</a></li>
<li class="chapter" data-level="13.4.2" data-path="13-google-authorization-and-r.html"><a href="13-google-authorization-and-r.html#enable-apis"><i class="fa fa-check"></i><b>13.4.2</b> Enable APIs</a></li>
<li class="chapter" data-level="13.4.3" data-path="13-google-authorization-and-r.html"><a href="13-google-authorization-and-r.html#create-a-service-account"><i class="fa fa-check"></i><b>13.4.3</b> Create a Service Account</a></li>
<li class="chapter" data-level="13.4.4" data-path="13-google-authorization-and-r.html"><a href="13-google-authorization-and-r.html#create-a-key-for-your-service-account"><i class="fa fa-check"></i><b>13.4.4</b> Create a Key for your service account</a></li>
<li class="chapter" data-level="13.4.5" data-path="13-google-authorization-and-r.html"><a href="13-google-authorization-and-r.html#share-the-google-drive-resources-of-interest-with-the-service-account"><i class="fa fa-check"></i><b>13.4.5</b> Share the Google drive resources of interest with the service account</a></li>
</ul></li>
<li class="chapter" data-level="13.5" data-path="13-google-authorization-and-r.html"><a href="13-google-authorization-and-r.html#general-approach-to-securely-managing-keys"><i class="fa fa-check"></i><b>13.5</b> General approach to securely managing keys</a><ul>
<li class="chapter" data-level="13.5.1" data-path="13-google-authorization-and-r.html"><a href="13-google-authorization-and-r.html#provide-a-service-account-key-for-projects"><i class="fa fa-check"></i><b>13.5.1</b> Provide a service account key for projects</a></li>
<li class="chapter" data-level="13.5.2" data-path="13-google-authorization-and-r.html"><a href="13-google-authorization-and-r.html#securely-managing-your-keys-for-packages"><i class="fa fa-check"></i><b>13.5.2</b> Securely managing your keys for Packages</a></li>
</ul></li>
<li class="chapter" data-level="13.6" data-path="13-google-authorization-and-r.html"><a href="13-google-authorization-and-r.html#additional-resources-2"><i class="fa fa-check"></i><b>13.6</b> Additional Resources</a><ul>
<li class="chapter" data-level="13.6.1" data-path="13-google-authorization-and-r.html"><a href="13-google-authorization-and-r.html#google-drive"><i class="fa fa-check"></i><b>13.6.1</b> Google Drive</a></li>
<li class="chapter" data-level="13.6.2" data-path="13-google-authorization-and-r.html"><a href="13-google-authorization-and-r.html#google-sheets"><i class="fa fa-check"></i><b>13.6.2</b> Google Sheets</a></li>
<li class="chapter" data-level="13.6.3" data-path="13-google-authorization-and-r.html"><a href="13-google-authorization-and-r.html#gargle"><i class="fa fa-check"></i><b>13.6.3</b> Gargle</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="14-encryption.html"><a href="14-encryption.html"><i class="fa fa-check"></i><b>14</b> Encryption</a><ul>
<li class="chapter" data-level="14.0.1" data-path="14-encryption.html"><a href="14-encryption.html#set-up-keybase"><i class="fa fa-check"></i><b>14.0.1</b> Set up Keybase</a></li>
<li class="chapter" data-level="14.0.2" data-path="14-encryption.html"><a href="14-encryption.html#install-gpg-and-git-crypt"><i class="fa fa-check"></i><b>14.0.2</b> Install <code>gpg</code> and <code>git-crypt</code></a></li>
<li class="chapter" data-level="14.0.3" data-path="14-encryption.html"><a href="14-encryption.html#create-your-keybase-keys"><i class="fa fa-check"></i><b>14.0.3</b> Create your Keybase keys</a></li>
<li class="chapter" data-level="14.0.4" data-path="14-encryption.html"><a href="14-encryption.html#import-your-keys-to-your-local-keychain"><i class="fa fa-check"></i><b>14.0.4</b> Import your keys to your local keychain</a></li>
<li class="chapter" data-level="14.0.5" data-path="14-encryption.html"><a href="14-encryption.html#set-the-text-entry-for-gpg"><i class="fa fa-check"></i><b>14.0.5</b> Set the text entry for gpg</a></li>
<li class="chapter" data-level="14.0.6" data-path="14-encryption.html"><a href="14-encryption.html#also-import-your-keys-to-the-eha-server"><i class="fa fa-check"></i><b>14.0.6</b> Also import your keys to the EHA server</a></li>
<li class="chapter" data-level="14.0.7" data-path="14-encryption.html"><a href="14-encryption.html#use-git-crypt"><i class="fa fa-check"></i><b>14.0.7</b> Use git-crypt</a></li>
<li class="chapter" data-level="14.0.8" data-path="14-encryption.html"><a href="14-encryption.html#extra-use-a-symmetric-key-for-automated-processes"><i class="fa fa-check"></i><b>14.0.8</b> Extra: Use a symmetric key for automated processes</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="15-dependencies.html"><a href="15-dependencies.html"><i class="fa fa-check"></i><b>15</b> Dependency Management</a></li>
<li class="chapter" data-level="16" data-path="16-statistical-methods.html"><a href="16-statistical-methods.html"><i class="fa fa-check"></i><b>16</b> Statistical Methods</a><ul>
<li class="chapter" data-level="16.1" data-path="16-statistical-methods.html"><a href="16-statistical-methods.html#multivariate-regression"><i class="fa fa-check"></i><b>16.1</b> Multivariate Regression</a></li>
<li class="chapter" data-level="16.2" data-path="16-statistical-methods.html"><a href="16-statistical-methods.html#networks"><i class="fa fa-check"></i><b>16.2</b> Networks</a></li>
<li class="chapter" data-level="16.3" data-path="16-statistical-methods.html"><a href="16-statistical-methods.html#bioinformatics-and-sequence-analysis"><i class="fa fa-check"></i><b>16.3</b> Bioinformatics and Sequence Analysis</a></li>
<li class="chapter" data-level="16.4" data-path="16-statistical-methods.html"><a href="16-statistical-methods.html#species-distribution-modeling"><i class="fa fa-check"></i><b>16.4</b> Species Distribution Modeling</a></li>
<li class="chapter" data-level="16.5" data-path="16-statistical-methods.html"><a href="16-statistical-methods.html#epidemic-simulation-and-fitting"><i class="fa fa-check"></i><b>16.5</b> Epidemic Simulation and Fitting</a></li>
<li class="chapter" data-level="16.6" data-path="16-statistical-methods.html"><a href="16-statistical-methods.html#phylogenetics"><i class="fa fa-check"></i><b>16.6</b> Phylogenetics</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="17-data-sources.html"><a href="17-data-sources.html"><i class="fa fa-check"></i><b>17</b> Data Sources</a></li>
<li class="chapter" data-level="18" data-path="18-references.html"><a href="18-references.html"><i class="fa fa-check"></i><b>18</b> References</a><ul>
<li class="chapter" data-level="18.1" data-path="18-references.html"><a href="18-references.html#converting-paperpile-citations-in-google-docs-to-endnote-citations-in-ms-word"><i class="fa fa-check"></i><b>18.1</b> Converting Paperpile Citations in Google Docs to Endnote Citations in MS Word</a></li>
</ul></li>
<li class="chapter" data-level="19" data-path="19-training-resources-and-plans.html"><a href="19-training-resources-and-plans.html"><i class="fa fa-check"></i><b>19</b> Training Resources and Plans</a><ul>
<li class="chapter" data-level="19.1" data-path="19-training-resources-and-plans.html"><a href="19-training-resources-and-plans.html#training-plan-components"><i class="fa fa-check"></i><b>19.1</b> Training plan components</a></li>
<li class="chapter" data-level="19.2" data-path="19-training-resources-and-plans.html"><a href="19-training-resources-and-plans.html#training-plans"><i class="fa fa-check"></i><b>19.2</b> Training Plans</a><ul>
<li class="chapter" data-level="19.2.1" data-path="19-training-resources-and-plans.html"><a href="19-training-resources-and-plans.html#better-managing-data"><i class="fa fa-check"></i><b>19.2.1</b> Better Managing Data</a></li>
<li class="chapter" data-level="19.2.2" data-path="19-training-resources-and-plans.html"><a href="19-training-resources-and-plans.html#version-control-and-git"><i class="fa fa-check"></i><b>19.2.2</b> Version Control and Git</a></li>
<li class="chapter" data-level="19.2.3" data-path="19-training-resources-and-plans.html"><a href="19-training-resources-and-plans.html#reproducible-reporting"><i class="fa fa-check"></i><b>19.2.3</b> Reproducible reporting</a></li>
<li class="chapter" data-level="19.2.4" data-path="19-training-resources-and-plans.html"><a href="19-training-resources-and-plans.html#improving-your-statistical-fundamentals"><i class="fa fa-check"></i><b>19.2.4</b> Improving Your Statistical Fundamentals</a></li>
<li class="chapter" data-level="19.2.5" data-path="19-training-resources-and-plans.html"><a href="19-training-resources-and-plans.html#improving-your-data-visualization"><i class="fa fa-check"></i><b>19.2.5</b> Improving your data visualization</a></li>
<li class="chapter" data-level="19.2.6" data-path="19-training-resources-and-plans.html"><a href="19-training-resources-and-plans.html#r-programming"><i class="fa fa-check"></i><b>19.2.6</b> R Programming</a></li>
<li class="chapter" data-level="19.2.7" data-path="19-training-resources-and-plans.html"><a href="19-training-resources-and-plans.html#map-making-and-geospatial-analysis-in-r"><i class="fa fa-check"></i><b>19.2.7</b> Map-making and geospatial analysis in R</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="20" data-path="20-help.html"><a href="20-help.html"><i class="fa fa-check"></i><b>20</b> Getting Help</a><ul>
<li class="chapter" data-level="20.1" data-path="20-help.html"><a href="20-help.html#minimal-reproducible-examples---helping-others-help-you"><i class="fa fa-check"></i><b>20.1</b> Minimal reproducible examples - helping others help you</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">EHA Modeling &amp; Analytics Handbook</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="google-authorization-and-r" class="section level1">
<h1><span class="header-section-number">13</span> Google Authorization and R</h1>
<p>EcoHealth Alliance sometimes uses Google Drive, and Google Sheets in particular, to store and collaborate on data. Working with Google Drive-based files in R is relatively painless thanks to the <a href="https://googledrive.tidyverse.org/"><code>googledrive</code></a>, <a href="https://googlesheets4.tidyverse.org/index.html"><code>googlesheets4</code></a>, and <a href="https://gargle.r-lib.org/index.html"><code>gargle</code></a> packages.</p>
<p>What is less straightforward is working with drive based files without having to manually authenticate your identity. In this chapter, we will walk through the process of creating credentials with API access that can be used in your R project or package. Ultimately, this could allow you to fully automate your Google-centric data pipelines.</p>
<div id="the-basic-overview" class="section level2">
<h2><span class="header-section-number">13.1</span> The basic overview:</h2>
<ol start="0" style="list-style-type: decimal">
<li>Create or store something (sheet, csv, doc, etc.) in Google drive</li>
<li>Create a <em>Google Cloud project</em> to manage Google services<br />
</li>
<li>Enable the appropriate APIs for the project so it can access things like Drive and Sheets.</li>
<li>Create a <em>service account</em> so that you can access the APIs via credentials from R</li>
<li>Encrypt credentials then add them to your R project so that you can still use <code>git</code>-based workflows without leaking access to your service account</li>
<li>Share Google-based resources with the service account and check that credentials work as expected from R</li>
<li>Add an encryption key to RStudio Connect or Github as an environment variable so that R can access the resources in automated workflows</li>
</ol>
</div>
<div id="key-terms" class="section level2">
<h2><span class="header-section-number">13.2</span> Key Terms</h2>
<ul>
<li><strong>Authentication</strong> - Confirms the identity of an entity</li>
<li><strong>Authorization</strong> - Permits an entity to do something
<ul>
<li><strong>Auth</strong> - shorthand for authentication or authorization</li>
</ul></li>
<li><strong>Key</strong> or <strong>Token</strong>- Computer-generated credentials that allow for authorization and authentication. In the R-Google universe <em>key</em> and <em>token</em> are synonyms, though not all services use this way, at at times okens and keys are communicated over the web using different method. You will see these terms used interchangeably in tutorials.</li>
<li><strong>Symmetric encryption</strong> - A type of encryption that uses a singlekey to encrypt and decrypt an object</li>
<li><strong>Environment variable</strong> - A value stored in a computer’s <em>system environment</em>. In R, this generally means values stored in the <code>.Renviron</code> file, which can be brought into your project using <code>Sys.getenv("Variable_Name")</code> and are very useful for storing sensitive information like tokens and keys.</li>
<li><strong>Service</strong> - Functionality provided by another system i.e. serving data via an API.</li>
<li><strong>GCP</strong> - Google cloud platform. Web services from Google.</li>
</ul>
</div>
<div id="before-we-start" class="section level2">
<h2><span class="header-section-number">13.3</span> Before we start:</h2>
<p><em>Note</em>: This is one workflow for encryption. An alternative approach useful for complex projects uses <code>git-crypt</code> instead. See chapter <a href="14-encryption.html#encryption">14</a> for more on <code>git-crypt</code>.</p>
<p><em>Credit</em>: This chapter largely follows the<br />
<a href="https://gargle.r-lib.org/articles/non-interactive-auth.html">non-interactive auth vignette from the Gargle R package</a>, but diverges for package and non-package focused projects.</p>
<p><em>What about Billing?</em>: Good question. This is not an issue for Google Sheets or Drive APIs but you do need a linked billing account for BigQuery and Maps APIs. If you’re new to GCP as of 29 Sept 2021 you get $300 of credits in the Free Tier. If you use the $300 in credits GCP will ask for consent before billing. Check with the Data Librarian about using and billing arrangements beyond this.</p>
</div>
<div id="setting-up-non-interactive-authentication-for-google-sheets" class="section level2">
<h2><span class="header-section-number">13.4</span> Setting up non-interactive authentication for Google sheets</h2>
<p>In this chapter, we will walk through setting up credentials that can be used in R to access Google sheets without manual authentication. To achieve non-interactive authorization, we want to either provide a <em>token</em> directly to a service or make a token discoverable for a service. A token is essentially a long password, designed to be exchanged by machines but too long and complexly formatted to be used by people, and often time-limited. Remember that tokens, secrets, and API keys should be stored in a secure fashion (NOT stored in the text of your code or in unencrypted files).</p>
<p>We are going to follow the recommended (as of 29 September 2021) strategy of providing a <em>service account key</em> directly to handle authorization. A newer approach called “workload identity federation” exists as of writing but is not fully implemented in the <code>gargle</code> package.</p>
<div id="create-a-google-cloud-platform-project" class="section level3">
<h3><span class="header-section-number">13.4.1</span> Create a Google cloud platform project</h3>
<p>“Google Cloud projects form the basis for creating, enabling, and using all Google Cloud services including managing APIs, enabling billing, adding and removing collaborators, and managing permissions for Google Cloud resources.” - <a href="https://cloud.google.com/resource-manager/docs/creating-managing-projects"><em>GCP Docs</em></a></p>
<p>We will use a GCP project to access the Google sheets API via a service account. You do not need a profound understanding of GCP projects to setup a service account.</p>
<ul>
<li>Setup/view your <a href="https://console.cloud.Google.com/">Google cloud account</a></li>
<li>Create a project on Google cloud to hold your credentials <img src="assets/gcp_console.png" alt="gcp console" /> <img src="assets/gcp_create_proj.png" alt="gcp project init" /></li>
<li>The GCP console is your destination for monitoring and modifying your projects</li>
</ul>
</div>
<div id="enable-apis" class="section level3">
<h3><span class="header-section-number">13.4.2</span> Enable APIs</h3>
<p>GCP Projects are centered on the idea that a single project will contain a single application. In our case, the application we are creating relies on the Google Sheets API. You can enable API’s for our application to access via the APIs &amp; Services menu item.</p>
<ul>
<li>In the left side menu, navigate to APIs &amp; Services &gt; Library <img src="assets/gcp_nav_lib.png" alt="naviate to Library" /></li>
<li>Choose your api of interest. For this example it is Google sheets. <img src="assets/gcp_find_sheets.png" alt="find sheets" /></li>
<li>Enable the api of interest. <em>If you need to enable more API’s later you can always come back</em>.<img src="assets/gcp_enable_sheets.png" alt="enable sheets" /></li>
</ul>
</div>
<div id="create-a-service-account" class="section level3">
<h3><span class="header-section-number">13.4.3</span> Create a Service Account</h3>
<p>Service accounts allow applications, like the GCP project we make, to access certain resources they need via authorized API calls. The service account’s access can be limited such that it can only access specific resources in a certain way.</p>
<p>Importantly, service accounts are not part of the EHA workspace domain. You have to manually share resources like Google sheets with a service account even if you have provided domain-level access.</p>
<p><a href="https://cloud.google.com/iam/docs/service-accounts">GCP Service Account Docs</a></p>
<ul>
<li>Navigate back to your project homepage</li>
<li>In the left sidebar go to IAM &amp; Admin &gt; Service Accounts <img src="assets/gcp_nav_service.png" alt="gcp_nav_service" /></li>
<li>Click create service account</li>
<li>Give it a good name and description <img src="assets/gcp_create_service_acnt.png" alt="gcp_create_service_acnt" /></li>
<li>For Google sheets, we do not need to assign our account service a role
<ul>
<li>Roles can be established to perform tests and otherwise manage the service but are not necessary</li>
</ul></li>
<li>Also not necessary to grant user access for this example
<ul>
<li>You may have a need for this with more complicated services</li>
<li>It may also be a good idea to get some redundancy in your workflow <img src="assets/gcp_service_setup.png" alt="gcp_service_setup" /></li>
</ul></li>
</ul>
</div>
<div id="create-a-key-for-your-service-account" class="section level3">
<h3><span class="header-section-number">13.4.4</span> Create a Key for your service account</h3>
<p>Keys for Google service accounts are stored in JSON files. Remember that this key will hold very sensitive information and we should treat it like a username and password combo.</p>
<ul>
<li><p>Click on the appropriate item in the service accounts table. <em>Notice that it says no key</em>.<img src="assets/gcp_nav_key.png" alt="gcp_nav_key" /></p></li>
<li><p>Click on the keys tab, then click on <strong>ADD KEY</strong> <img src="assets/gcp_add_key.png" alt="gcp_add_key" /></p></li>
<li><p>Select create new key and download the JSON file. <strong>WARNING:</strong> Do not store this unencrypted key in a shared location (Dropbox, Google Drive, folder connected to a git repository). <img src="assets/gcp_get_key.png" alt="gcp_get_key" /></p></li>
<li><p>You should now see that there is an active key associated with your service account in the GCP project.</p></li>
</ul>
</div>
<div id="share-the-google-drive-resources-of-interest-with-the-service-account" class="section level3">
<h3><span class="header-section-number">13.4.5</span> Share the Google drive resources of interest with the service account</h3>
<ul>
<li><strong>Make sure your sheet is shared with the service account</strong></li>
<li>Remember that service accounts do not belong the EHA domain so there will be extra prompts when sharing resources.</li>
</ul>
</div>
</div>
<div id="general-approach-to-securely-managing-keys" class="section level2">
<h2><span class="header-section-number">13.5</span> General approach to securely managing keys</h2>
<p>This workflow uses the relatively simple approach of symmetric encryption to securely store files on shared resources like a github repository. Symmetric encryption uses a single key to encrypt and decrypt files. In this workflow, the key is generated from a passphrase.</p>
<ol style="list-style-type: decimal">
<li>Unencrypted files storing keys for the Google service account should NOT be stored in shared or public locations (Drive, Dropbox, Github Repo)
<ul>
<li>If possible store in an encrypted volume. Keybase, Bitwarden, and other credential management storage systems generally allow you to store files in an encrypted manner.</li>
</ul></li>
<li>Files storing keys for the Google service account only ever enter the project working directory after being encrypted</li>
<li>Encryption keys or the passwords used to generate keys are stored as environment variables and retrieved from <code>.Renviron</code>, never hard-coded into scripts.</li>
</ol>
<p>Skip ahead to <a href="13-google-authorization-and-r.html#securely-managing-your-keys-for-packages">Securely managing your keys for packages</a> if you are using the key in a project that produces a package.</p>
<div id="provide-a-service-account-key-for-projects" class="section level3">
<h3><span class="header-section-number">13.5.1</span> Provide a service account key for projects</h3>
<p>Now you have a secret key for the service account and need to securely access it in an R project. We can use the <code>sodium</code> and <code>gargle</code> packages to encrypt the JSON file that stores our key, safely store the encrypted file in the R project, and securely store the encryption key as an environment variable. If additional files or data require encryption it is recommended that use the <code>git-crypt</code> approached described in chapter <a href="14-encryption.html#encryption">14</a>.</p>
<p>This section was inspired by the workflow described in <a href="https://books.ropensci.org/http-testing/security-chapter.html">ROpenSci:Security</a> with additional information from the <a href="https://cran.r-project.org/web/packages/sodium/vignettes/intro.html">sodium vignette</a> and <a href="https://gargle.r-lib.org/articles/articles/managing-tokens-securely.html">gargle vignette</a>.</p>
<div id="create-and-store-encryption-password" class="section level4">
<h4><span class="header-section-number">13.5.1.1</span> Create and store encryption password</h4>
<p>Here we will create an environment variable to store our encryption password.</p>
<ul>
<li>We will store it in the <em>user-level</em> <code>.Renviron</code> file that is outside of your project repository so it is not accidentally committed to your project.</li>
</ul>
<p>Creating your password encrypting the key should only need to be done once, then we will write code that makes use of your encrypted key every time it runs.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="13-google-authorization-and-r.html#cb11-1"></a><span class="kw">library</span>(sodium)</span>
<span id="cb11-2"><a href="13-google-authorization-and-r.html#cb11-2"></a><span class="kw">library</span>(gargle)</span>
<span id="cb11-3"><a href="13-google-authorization-and-r.html#cb11-3"></a><span class="kw">library</span>(usethis)</span>
<span id="cb11-4"><a href="13-google-authorization-and-r.html#cb11-4"></a><span class="kw">library</span>(readr)</span>
<span id="cb11-5"><a href="13-google-authorization-and-r.html#cb11-5"></a></span>
<span id="cb11-6"><a href="13-google-authorization-and-r.html#cb11-6"></a><span class="co">## Name of Environment variable</span></span>
<span id="cb11-7"><a href="13-google-authorization-and-r.html#cb11-7"></a></span>
<span id="cb11-8"><a href="13-google-authorization-and-r.html#cb11-8"></a>pw_name &lt;-<span class="st"> </span>gargle<span class="op">:::</span><span class="kw">secret_pw_name</span>(<span class="st">&quot;service_account&quot;</span>)</span>
<span id="cb11-9"><a href="13-google-authorization-and-r.html#cb11-9"></a><span class="co">#&gt; SERVICE_ACCOUNT_PASSWORD</span></span>
<span id="cb11-10"><a href="13-google-authorization-and-r.html#cb11-10"></a></span>
<span id="cb11-11"><a href="13-google-authorization-and-r.html#cb11-11"></a><span class="co">## Value of Environment variable</span></span>
<span id="cb11-12"><a href="13-google-authorization-and-r.html#cb11-12"></a></span>
<span id="cb11-13"><a href="13-google-authorization-and-r.html#cb11-13"></a>pw &lt;-<span class="st"> </span>gargle<span class="op">:::</span><span class="kw">secret_pw_gen</span>()</span>
<span id="cb11-14"><a href="13-google-authorization-and-r.html#cb11-14"></a><span class="co">#&gt; someSecretComplicatedPassword</span></span>
<span id="cb11-15"><a href="13-google-authorization-and-r.html#cb11-15"></a></span>
<span id="cb11-16"><a href="13-google-authorization-and-r.html#cb11-16"></a><span class="kw">sprintf</span>(<span class="st">&quot;%s=%s&quot;</span>,pw_name, pw)</span>
<span id="cb11-17"><a href="13-google-authorization-and-r.html#cb11-17"></a><span class="co">#&gt; SERVICE_ACCOUNT_PASSWORD=someSecretComplicatedPassword</span></span>
<span id="cb11-18"><a href="13-google-authorization-and-r.html#cb11-18"></a></span>
<span id="cb11-19"><a href="13-google-authorization-and-r.html#cb11-19"></a>usethis<span class="op">::</span><span class="kw">edit_r_environ</span>(<span class="dt">scope =</span> <span class="st">&quot;user&quot;</span>)</span>
<span id="cb11-20"><a href="13-google-authorization-and-r.html#cb11-20"></a></span>
<span id="cb11-21"><a href="13-google-authorization-and-r.html#cb11-21"></a><span class="co">#### Copy and paste pw_name=pw into .Renviron file </span><span class="al">###</span></span>
<span id="cb11-22"><a href="13-google-authorization-and-r.html#cb11-22"></a><span class="co"># 1 SERVICE_ACCOUNT_PASSWORD=someSecretComplicatedPassword</span></span>
<span id="cb11-23"><a href="13-google-authorization-and-r.html#cb11-23"></a><span class="co"># 2 </span></span>
<span id="cb11-24"><a href="13-google-authorization-and-r.html#cb11-24"></a></span>
<span id="cb11-25"><a href="13-google-authorization-and-r.html#cb11-25"></a><span class="co"># always leave an empty line at the end of the .Renviron file</span></span></code></pre></div>
</div>
<div id="create-encryption-key" class="section level4">
<h4><span class="header-section-number">13.5.1.2</span> Create encryption key</h4>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="13-google-authorization-and-r.html#cb12-1"></a>make_sodium_key &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">env_var_name =</span> <span class="st">&quot;SERVICE_ACCOUNT_PASSWORD&quot;</span>){</span>
<span id="cb12-2"><a href="13-google-authorization-and-r.html#cb12-2"></a></span>
<span id="cb12-3"><a href="13-google-authorization-and-r.html#cb12-3"></a>  pw &lt;-<span class="st"> </span><span class="kw">Sys.getenv</span>(env_name)</span>
<span id="cb12-4"><a href="13-google-authorization-and-r.html#cb12-4"></a>  </span>
<span id="cb12-5"><a href="13-google-authorization-and-r.html#cb12-5"></a>  <span class="co"># we use scrypt as our hashing function because it makes keys difficult</span></span>
<span id="cb12-6"><a href="13-google-authorization-and-r.html#cb12-6"></a>  <span class="co"># to brute force. </span></span>
<span id="cb12-7"><a href="13-google-authorization-and-r.html#cb12-7"></a>  k &lt;-<span class="st"> </span>sodium<span class="op">::</span><span class="kw">scrypt</span>(<span class="kw">charToRaw</span>(pw))</span>
<span id="cb12-8"><a href="13-google-authorization-and-r.html#cb12-8"></a>  </span>
<span id="cb12-9"><a href="13-google-authorization-and-r.html#cb12-9"></a>  <span class="kw">return</span>(k)</span>
<span id="cb12-10"><a href="13-google-authorization-and-r.html#cb12-10"></a></span>
<span id="cb12-11"><a href="13-google-authorization-and-r.html#cb12-11"></a>}</span>
<span id="cb12-12"><a href="13-google-authorization-and-r.html#cb12-12"></a></span>
<span id="cb12-13"><a href="13-google-authorization-and-r.html#cb12-13"></a>key &lt;-<span class="st"> </span><span class="kw">make_sodium_key</span>()</span>
<span id="cb12-14"><a href="13-google-authorization-and-r.html#cb12-14"></a></span>
<span id="cb12-15"><a href="13-google-authorization-and-r.html#cb12-15"></a><span class="co"># The key we just made is binary so it has to be converted to character in order</span></span>
<span id="cb12-16"><a href="13-google-authorization-and-r.html#cb12-16"></a><span class="co"># to be stored in .Renviron </span></span>
<span id="cb12-17"><a href="13-google-authorization-and-r.html#cb12-17"></a></span>
<span id="cb12-18"><a href="13-google-authorization-and-r.html#cb12-18"></a>sodium<span class="op">::</span><span class="kw">bin2hex</span>(key)</span>
<span id="cb12-19"><a href="13-google-authorization-and-r.html#cb12-19"></a></span>
<span id="cb12-20"><a href="13-google-authorization-and-r.html#cb12-20"></a>usethis<span class="op">::</span><span class="kw">edit_r_environ</span>(<span class="dt">scope =</span> <span class="st">&quot;user&quot;</span>)</span>
<span id="cb12-21"><a href="13-google-authorization-and-r.html#cb12-21"></a></span>
<span id="cb12-22"><a href="13-google-authorization-and-r.html#cb12-22"></a><span class="co">########### .Renviron file ####################</span></span>
<span id="cb12-23"><a href="13-google-authorization-and-r.html#cb12-23"></a><span class="co"># 1 SERVICE_ACCOUNT_PASSWORD=someSecretComplicatedPassword</span></span>
<span id="cb12-24"><a href="13-google-authorization-and-r.html#cb12-24"></a><span class="co"># 2 SERVICE_ACCOUNT_NA_KEY=output_from_bin2hex_function </span></span>
<span id="cb12-25"><a href="13-google-authorization-and-r.html#cb12-25"></a><span class="co"># 3</span></span>
<span id="cb12-26"><a href="13-google-authorization-and-r.html#cb12-26"></a></span>
<span id="cb12-27"><a href="13-google-authorization-and-r.html#cb12-27"></a><span class="co"># always leave an empty line at the end of the .Renviron file</span></span></code></pre></div>
</div>
<div id="symmetrically-encrypt-your-file" class="section level4">
<h4><span class="header-section-number">13.5.1.3</span> Symmetrically encrypt your file</h4>
<p>Now that we have a sodium key stored as an environment variable, we can symmetrically encrypt our JSON file that stores the service account key. The encrypted file will live in <code>inst/tokens</code> within your working directory. After the file has been encrypted it is safe to push it to a remote git repository.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="13-google-authorization-and-r.html#cb13-1"></a><span class="co"># get your sodium key from the environment variable</span></span>
<span id="cb13-2"><a href="13-google-authorization-and-r.html#cb13-2"></a>get_sodium_key &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">env_var_name =</span> <span class="st">&quot;SERVICE_ACCOUNT_NA_KEY&quot;</span>){</span>
<span id="cb13-3"><a href="13-google-authorization-and-r.html#cb13-3"></a>  k &lt;-<span class="st"> </span>sodium<span class="op">::</span><span class="kw">hex2bin</span>(<span class="kw">Sys.getenv</span>(env_var_name))</span>
<span id="cb13-4"><a href="13-google-authorization-and-r.html#cb13-4"></a>  <span class="kw">return</span>(k)</span>
<span id="cb13-5"><a href="13-google-authorization-and-r.html#cb13-5"></a>}</span>
<span id="cb13-6"><a href="13-google-authorization-and-r.html#cb13-6"></a></span>
<span id="cb13-7"><a href="13-google-authorization-and-r.html#cb13-7"></a>key &lt;-<span class="st"> </span><span class="kw">get_sodium_key</span>()</span>
<span id="cb13-8"><a href="13-google-authorization-and-r.html#cb13-8"></a></span>
<span id="cb13-9"><a href="13-google-authorization-and-r.html#cb13-9"></a><span class="co"># Our encrypted file will live here</span></span>
<span id="cb13-10"><a href="13-google-authorization-and-r.html#cb13-10"></a><span class="kw">dir.create</span>(<span class="st">&quot;./inst/tokens&quot;</span>,<span class="dt">recursive =</span> T)</span>
<span id="cb13-11"><a href="13-google-authorization-and-r.html#cb13-11"></a></span>
<span id="cb13-12"><a href="13-google-authorization-and-r.html#cb13-12"></a>binJSON &lt;-<span class="st"> </span>readr<span class="op">::</span><span class="kw">read_file_raw</span>(<span class="st">&quot;My/directory/outside/the/project/service_account_key.json&quot;</span>)</span>
<span id="cb13-13"><a href="13-google-authorization-and-r.html#cb13-13"></a></span>
<span id="cb13-14"><a href="13-google-authorization-and-r.html#cb13-14"></a>cipher &lt;-<span class="st"> </span><span class="kw">data_encrypt</span>(<span class="dt">msg =</span> binJSON, <span class="dt">key =</span> key2,<span class="dt">nonce =</span> <span class="kw">random</span>(<span class="dv">24</span>))</span>
<span id="cb13-15"><a href="13-google-authorization-and-r.html#cb13-15"></a></span>
<span id="cb13-16"><a href="13-google-authorization-and-r.html#cb13-16"></a><span class="co"># The encrypted file in inst/tokens is now safe to push to a remote repository</span></span>
<span id="cb13-17"><a href="13-google-authorization-and-r.html#cb13-17"></a><span class="kw">saveRDS</span>(cipher, <span class="st">&quot;./inst/tokens/service_account_key.rds&quot;</span>)</span></code></pre></div>
</div>
<div id="run-your-code-using-encrypted-keys" class="section level4">
<h4><span class="header-section-number">13.5.1.4</span> Run your code using encrypted keys</h4>
<p>In the code that reads in data from Google, decrypt the credentials then pass them to Google using the <code>gs4_auth</code> function:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="13-google-authorization-and-r.html#cb14-1"></a><span class="kw">library</span>(googlesheets4)</span>
<span id="cb14-2"><a href="13-google-authorization-and-r.html#cb14-2"></a></span>
<span id="cb14-3"><a href="13-google-authorization-and-r.html#cb14-3"></a>key &lt;-<span class="st"> </span><span class="kw">get_sodium_key</span>()</span>
<span id="cb14-4"><a href="13-google-authorization-and-r.html#cb14-4"></a></span>
<span id="cb14-5"><a href="13-google-authorization-and-r.html#cb14-5"></a>service_account_token &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;./inst/tokens/service_account_key.rds&quot;</span>)</span>
<span id="cb14-6"><a href="13-google-authorization-and-r.html#cb14-6"></a></span>
<span id="cb14-7"><a href="13-google-authorization-and-r.html#cb14-7"></a>jsonRaw &lt;-<span class="st"> </span>sodium<span class="op">:::</span><span class="kw">data_decrypt</span>(service_account_token,<span class="dt">key =</span> key)</span>
<span id="cb14-8"><a href="13-google-authorization-and-r.html#cb14-8"></a></span>
<span id="cb14-9"><a href="13-google-authorization-and-r.html#cb14-9"></a>jsonChar &lt;-<span class="st"> </span><span class="kw">rawToChar</span>(jsonRaw)</span>
<span id="cb14-10"><a href="13-google-authorization-and-r.html#cb14-10"></a></span>
<span id="cb14-11"><a href="13-google-authorization-and-r.html#cb14-11"></a>googlesheets4<span class="op">::</span><span class="kw">gs4_auth</span>(<span class="dt">path =</span> jsonChar)</span></code></pre></div>
</div>
<div id="read-in-your-sheet" class="section level4">
<h4><span class="header-section-number">13.5.1.5</span> Read in your sheet</h4>
<ul>
<li><em>Make sure your sheet is shared with the service account if it hasn’t been already</em></li>
</ul>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="13-google-authorization-and-r.html#cb15-1"></a>googlesheets4<span class="op">::</span><span class="kw">read_sheet</span>(<span class="st">&quot;https://docs.Google.com/spreadsheets/that/i/definitely/shared/with/the/service-account&quot;</span>)</span></code></pre></div>
</div>
<div id="add-environment-variable-to-other-services" class="section level4">
<h4><span class="header-section-number">13.5.1.6</span> Add Environment Variable to other services</h4>
<p>Non-interactive authentication allows us to automate workflows that involve Google sheets on services like Rstudio connect or Github Actions. In either case, it is relatively straight forward to securely add our <code>SERVICE_ACCOUNT_PASSWORD</code> environment variables to those services.</p>
<p>See documentation here:</p>
<ul>
<li><a href="https://blog.rstudio.com/2018/03/02/rstudio-connect-v1-5-14/#:~:text=Environment%20variables%20for%20executable%20content,and%20are%20encrypted%20at%20rest.">Add env variables to RSConnect</a></li>
<li><a href="https://help.github.com/en/actions/configuring-and-managing-workflows/creating-and-storing-encrypted-secrets">Add secrets to Github Actions</a></li>
</ul>
</div>
</div>
<div id="securely-managing-your-keys-for-packages" class="section level3">
<h3><span class="header-section-number">13.5.2</span> Securely managing your keys for Packages</h3>
<p>You can make your secret service account ky accessible to your R package. We will use the <code>sodium</code> package as well as functions in <code>gargle</code> to encrypt the JSON file that stores the key and securely store the <em>encryption</em> key as an environment variable. Notice that we are using the <code>:::</code> operator in function calls. See <a href="https://gargle.r-lib.org/articles/articles/managing-tokens-securely.html">this article</a> for more details.</p>
<div id="create-and-store-encryption-password-1" class="section level4">
<h4><span class="header-section-number">13.5.2.1</span> Create and store encryption password</h4>
<p>Here we will create an environment variable to store our encryption password.</p>
<ul>
<li>We will store it in the <em>user-level</em> <code>.Renviron</code> file that is outside of your project repository so it is not accidentally committed to your project.</li>
</ul>
<p>Creating your password encrypting the key should only need to be done once. The package can then use code that makes use of your encrypted key every time it runs.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="13-google-authorization-and-r.html#cb16-1"></a><span class="kw">library</span>(sodium)</span>
<span id="cb16-2"><a href="13-google-authorization-and-r.html#cb16-2"></a><span class="kw">library</span>(gargle)</span>
<span id="cb16-3"><a href="13-google-authorization-and-r.html#cb16-3"></a><span class="kw">library</span>(usethis)</span>
<span id="cb16-4"><a href="13-google-authorization-and-r.html#cb16-4"></a></span>
<span id="cb16-5"><a href="13-google-authorization-and-r.html#cb16-5"></a><span class="co">## Name of Environment variable</span></span>
<span id="cb16-6"><a href="13-google-authorization-and-r.html#cb16-6"></a></span>
<span id="cb16-7"><a href="13-google-authorization-and-r.html#cb16-7"></a>pw_name &lt;-<span class="st"> </span>gargle<span class="op">:::</span><span class="kw">secret_pw_name</span>(<span class="st">&quot;gargle&quot;</span>)</span>
<span id="cb16-8"><a href="13-google-authorization-and-r.html#cb16-8"></a><span class="co">#&gt; GARGLE_PASSWORD</span></span>
<span id="cb16-9"><a href="13-google-authorization-and-r.html#cb16-9"></a></span>
<span id="cb16-10"><a href="13-google-authorization-and-r.html#cb16-10"></a><span class="co">## Value of Environment variable</span></span>
<span id="cb16-11"><a href="13-google-authorization-and-r.html#cb16-11"></a></span>
<span id="cb16-12"><a href="13-google-authorization-and-r.html#cb16-12"></a>pw &lt;-<span class="st"> </span>gargle<span class="op">:::</span><span class="kw">secret_pw_gen</span>()</span>
<span id="cb16-13"><a href="13-google-authorization-and-r.html#cb16-13"></a><span class="co">#&gt; someSecretComplicatedPassword</span></span>
<span id="cb16-14"><a href="13-google-authorization-and-r.html#cb16-14"></a></span>
<span id="cb16-15"><a href="13-google-authorization-and-r.html#cb16-15"></a><span class="kw">sprintf</span>(<span class="st">&quot;%s=%s&quot;</span>,pw_name, pw)</span>
<span id="cb16-16"><a href="13-google-authorization-and-r.html#cb16-16"></a><span class="co">#&gt; GARGLE_PASSWORD=someSecretComplicatedPassword</span></span>
<span id="cb16-17"><a href="13-google-authorization-and-r.html#cb16-17"></a></span>
<span id="cb16-18"><a href="13-google-authorization-and-r.html#cb16-18"></a>usethis<span class="op">::</span><span class="kw">edit_r_environ</span>(<span class="dt">scope =</span> <span class="st">&quot;user&quot;</span>)</span>
<span id="cb16-19"><a href="13-google-authorization-and-r.html#cb16-19"></a></span>
<span id="cb16-20"><a href="13-google-authorization-and-r.html#cb16-20"></a><span class="co">#### in .Renviron file </span><span class="al">###</span></span>
<span id="cb16-21"><a href="13-google-authorization-and-r.html#cb16-21"></a><span class="co"># 1 GARGLE_PASSWORD=someSecretComplicatedPassword</span></span>
<span id="cb16-22"><a href="13-google-authorization-and-r.html#cb16-22"></a><span class="co"># 2 </span></span>
<span id="cb16-23"><a href="13-google-authorization-and-r.html#cb16-23"></a></span>
<span id="cb16-24"><a href="13-google-authorization-and-r.html#cb16-24"></a><span class="co"># always leave an empty line at the end of the .Renviron file</span></span></code></pre></div>
</div>
<div id="encrypt-the-secret-file" class="section level4">
<h4><span class="header-section-number">13.5.2.2</span> Encrypt the Secret File</h4>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="13-google-authorization-and-r.html#cb17-1"></a>gargle<span class="op">:::</span><span class="kw">secret_write</span>(</span>
<span id="cb17-2"><a href="13-google-authorization-and-r.html#cb17-2"></a>  <span class="dt">package =</span> <span class="st">&quot;myCoolPackage&quot;</span>,</span>
<span id="cb17-3"><a href="13-google-authorization-and-r.html#cb17-3"></a>  <span class="dt">name =</span> <span class="st">&quot;sheets-demo-key.json&quot;</span>,</span>
<span id="cb17-4"><a href="13-google-authorization-and-r.html#cb17-4"></a>  <span class="dt">input =</span> <span class="st">&quot;My/directory/outside/the/project/longComplicatedFile.json&quot;</span></span>
<span id="cb17-5"><a href="13-google-authorization-and-r.html#cb17-5"></a>)</span></code></pre></div>
</div>
<div id="test-that-you-can-decrypt" class="section level4">
<h4><span class="header-section-number">13.5.2.3</span> Test that you can decrypt</h4>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="13-google-authorization-and-r.html#cb18-1"></a><span class="cf">if</span>(gargle<span class="op">:::</span><span class="kw">secret_can_decrypt</span>(<span class="st">&quot;myCoolPackage&quot;</span>)){</span>
<span id="cb18-2"><a href="13-google-authorization-and-r.html#cb18-2"></a>  json&lt;-<span class="st"> </span>gargle<span class="op">:::</span><span class="kw">secret_read</span>(<span class="st">&quot;sheets-demo-key.json&quot;</span>)</span>
<span id="cb18-3"><a href="13-google-authorization-and-r.html#cb18-3"></a>  googlesheets4<span class="op">::</span><span class="kw">gs4_auth</span>(<span class="dt">path =</span> <span class="kw">rawToChar</span>(json))</span>
<span id="cb18-4"><a href="13-google-authorization-and-r.html#cb18-4"></a>}</span></code></pre></div>
</div>
<div id="give-the-env-variable-to-services-optional" class="section level4">
<h4><span class="header-section-number">13.5.2.4</span> Give the env variable to services (Optional)</h4>
<p>If the package will be used in services like RStudio Connect or Github Actions, it is relatively straight forward to securely add our <code>GARGLE_PASSWORD</code> environment variables to those services.</p>
<p>See documentation here:</p>
<ul>
<li><a href="https://blog.rstudio.com/2018/03/02/rstudio-connect-v1-5-14/#:~:text=Environment%20variables%20for%20executable%20content,and%20are%20encrypted%20at%20rest.">Add env variables to RSConnect</a></li>
<li><a href="https://help.github.com/en/actions/configuring-and-managing-workflows/creating-and-storing-encrypted-secrets">Add secrets to Github Actions</a></li>
</ul>
</div>
</div>
</div>
<div id="additional-resources-2" class="section level2">
<h2><span class="header-section-number">13.6</span> Additional Resources</h2>
<div id="google-drive" class="section level3">
<h3><span class="header-section-number">13.6.1</span> Google Drive</h3>
<p>The <a href="https://googledrive.tidyverse.org/"><code>googledrive</code></a> package allows you to interact with files stored in Google drive from R. You can download, share, delete, copy, publish and otherwise manipulate files on your drive using this package.</p>
<p>Package vignettes can be found <a href="https://googledrive.tidyverse.org/articles/index.html">here</a></p>
</div>
<div id="google-sheets" class="section level3">
<h3><span class="header-section-number">13.6.2</span> Google Sheets</h3>
<p>The <a href="https://googlesheets4.tidyverse.org/index.html"><code>googlesheets4</code></a> package allows you to directly interact with Google sheets in R. You can read, write, reformat, create formulas, and otherwise manipulate the sheet of interest.</p>
<p>Package vignettes can be found <a href="https://googlesheets4.tidyverse.org/articles/index.html">here</a></p>
</div>
<div id="gargle" class="section level3">
<h3><span class="header-section-number">13.6.3</span> Gargle</h3>
<p>The <a href="https://gargle.r-lib.org/index.html"><code>gargle</code></a> package focuses entirely on managing credentials for the Google api. Vignettes for the package can be found <a href="https://gargle.r-lib.org/articles/index.html">here</a>.</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="12-cloud-computing-services.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="14-encryption.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": false,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2,
"id": 1
},
"edit": {
"link": "https://github.com/ecohealthalliance/eha-ma-handbook/edit/master/google-auth.Rmd",
"text": "Edit this chapter"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section",
"scroll_highlight": true
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
