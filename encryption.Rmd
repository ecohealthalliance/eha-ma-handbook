# Encryption

- _How do we share data in git repositories that needs to be secure?_

Sometimes we need to store and share secure information, such as API keys to
paid online service accounts.  One of our methods of choice for this is to
keep these files stored in git/GitHub repositories, but to encrypt them.  We
do this using PGP (Pretty Good Privacy) encryption, implemented by the program
[`git-crypt`](https://github.com/AGWA/git-crypt).  It takes a bit to set up
but once activated makes sharing secure and seamless.

The PGP encryption scheme involves making a _public_ key that you share and
a _private_ key that you use to decrypt data encrypted with your public key.
We like and use [Keybase](https://keybase.io/), a service that helps you publish and
verify a public key for this purpose.

Instructions for setting this up are below.

### Set up Keybase

Sign up for [Keybase](https://keybase.io/), and follow the instructions for 
installing it on your laptop.

For installing on linux, first identify the distribution by entering
the following command into a terminal and noting down the Distributor ID.

    lsb_release -a

Next identify the architecture via,

    arch

Follow the instructions to install Keybase on Linux, available [here](https://keybase.io/docs/the_app/install_linux), 
making sure to use the section relevant to the architecture and distribution 
information identified above.

For installing on Windows, the easiest way is to download and install the
graphical user interface available from the Keybase 
[download page](https://keybase.io/download). This will also install the necessary
command line tools.

### Install `gpg` and `git-crypt`

`gpg` is the program that implements encryption, and `git-crypt` sets up git
repos for encrypted sharing.  These are already installed on EHA servers.  To install
them on a mac, use [`homebrew`](https://docs.brew.sh/Installation). You should also install `pinentry`.

```
# In Terminal 
## homebrew automatically updates when you run it so if you haven't used it in a
## while there may be a somewhat lengthy update

brew install gpg
brew install pinentry
brew install git-crypt
```

For Windows there are two alternative approaches. The first is to utilize the Windows Subsystem for Linux (WSL). This method requires Windows 10. For more information on using the WSL see this [guide](https://docs.microsoft.com/en-us/windows/wsl/install). After that all the necessary packages can be installed through the terminal using something like
 
```
sudo apt update
sudo apt install keybase gpg git-crypt
```

see the linux installation instructions above for more details.

The second method is to install pre-compiled binaries for GPG and git-crypt. A Windows compatible binary for GPG is available [here](https://gnupg.org/download/). The 'Simple installer for the current GnuPG' binary is the recommended choice.

Then install git-crypt by downloading `git-crypt-windows.zip` available [here](https://github.com/ecohealthalliance/git-crypt/releases/tag/win-release). This may generate the warning 'git-crypt-windows.zip is not commonly downloaded and may be dangerous'. Click the up arrow next to 'Discard' and select 'Keep'. Even after this the download may fail with the message 'Failed - Virus detected'. Do not worry this is a false positive. If this occurs, search for 'Virus & thread protection' in the task bar and click on 'Manage settings' under 'Virus & thread protection settings'. Once there, turn off Real-time protection and try downloading again. Please make sure to turn it back on again when done. Once downloaded, the zip file will then need to be decompressed using a file archive manager such as [PeaZip](https://peazip.github.io/). 

Now move the resulting .exe file into a folder recognized by the Windows PATH environment variable. A convenient location is `C:\Program Files\Git\cmd\`.

Once Keybase and GPG are installed, the terminal commands related to exporting keys from Kebyase
into GPG do not need to be modified to work in cmd or powershell.

### Create your Keybase keys 

If you are just starting to use Keybase, you can generate new keys for use on
your computer using [this guide](https://github.com/pstadler/keybase-gpg-github).
The guide also helps set up using your key to sign GitHub commits, which you
should do for added security.

Do create a password associated with your keys when asked.  You can store
this in a service such as LastPass or BitWarden if desired.

At this point you can go to your Keybase account and verify your keys via as
many other services, devices, or online identities as you want.  We suggest
at least three. It is also a good idea to generate a physical 'paper key' and store it in
a secure location.

### Import your keys to your local keychain

If you have a Keybase account set and keys already generated, you can now import
your Keybase keys to use.  Instruction are found [here](https://blog.scottlowe.org/2017/09/06/using-keybase-gpg-macos/). Do set
your keys to maximum trust level.


### Set the text entry for gpg 

A common source of errors is that the text entry for `gpg` isn't set properly. This means that `gpg` and your terminal aren't speaking the same language. You can fix this by setting the `GPG_TTY` environment variable like so:

    export GPG_TTY=$(tty)
    
Adding this to your `.profile`, `.bashrc`, `.zshrc` or other settings files prevents
having to run the command when you use git-crypt or sign commits. Use your favorite text editor (nano, vim, etc) to modify the settings file:

```
# on a mac in terminal
nano .zshrc

# in the nano editor

export GPG_TTY=$(tty)

```


### Also import your keys to the EHA server

You will probably want the ability to decrypt files when working remotely,
so place them on the EHA server.  You can do this by copying over your whole
`gpg` keys directory to the server, like so:

    scp -rp ~/.gnupg url.of.server:
    
For Windows users, the above command will work only after installing [PuTTY](https://www.putty.org/),
enabling Windows 10's [OpenSSH client](https://winaero.com/enable-openssh-client-windows-10/) or through use of the WLS.

Note that the main EHA analysis servers share user file systems so you only
have to do this on one of them.

You may have to edit the file `~/.gnupg/gpg-agent.conf` on the server.  If
its first line is `pinentry-program /usr/local/bin/pinentry-mac`, change it to
`pinentry-program /usr/bin/pinentry`. Note that it may not exist at all, which
is fine - it means the program is just using default behavior.

### Use git-crypt

The [`git-crypt` README](https://github.com/AGWA/git-crypt) outlines the basics
of using `git-crypt` to add encrypted files to a git repository.

To add contributors with access to the encrypted files in a repository, you first
have to add their public key to your keychain. Visit their Keybase profiles (e.g., <https://keybase.io/noamross>) and click on the key - it will show several ways 
to import the keys.

```
# curl + gpg pro tip: import noamross's keys
curl https://keybase.io/noamross/pgp_keys.asc | gpg --import

# the Keybase app can push to gpg keychain, too
keybase pgp pull noamross
```

Edit the key so that it has sufficient trust levels

```
# in terminal
## list keys 

gpg --list-keys

# edit the key you want to add to your repo so that it has sufficient trust levels

gpg --edit-keys 4A1653E6FDB48C85EC4702B9E7B170AD3B19DAA4

# you will now be in the key editor

trust

# select 5, ultimate 

5

# exit the key editor

quit

## add the person to your git repo (make sure you're in the right directory)
## this will automatically commit changes to your repo

git crypt add-gpg-user 4A1653E6FDB48C85EC4702B9E7B170AD3B19DAA4

# push changes to remote (github)

git push

```

Make sure your public key has been added to the repository. To do this, check the 
`.git-crypt/keys/default/0` folder in the repo for your public key. 

After pulling/cloning run

    git-crypt unlock
    
in the repository folder.  After that encryption and decryption for pushing and
pulling should happen automatically. If this produces and error double check that your
key was added and pull the repo before trying again. For Windows it may also be necessary
to inform git of the location of the gpg executable which can be done by opening cmd
or powershell and entering

  `git config --global gpg.program "C:\Program Files (x86)\GnuPG\bin\gpg.exe"`


Another common source of errors is that the text entry for `gpg` isn't set properly. You can fix this by setting the `GPG_TTY` environment variable like so:

    export GPG_TTY=$(tty)
    
Add this to your `.profile`, `.bashrc`, `.zshrc` or other settings file.

If `git-crypt unlock` still fails, try the following steps

1. Verify that GPG has successfully imported your private key from Keybase by opening a shell and entering
`gpg --list-secret-keys`. If no keys are found, follow the [guide](https://blog.scottlowe.org/2017/09/06/using-keybase-gpg-macos/) for importing keys.
2. Make sure that your GPG private key has actually been added to the repository. Navigate to the `~/.git-crypt/keys/default/0/` directory on github and look for a file that matches your public key.
3. Once your key has been added, pull from the remote to make sure the key is available to your local repository.


### Extra: Use a symmetric key for automated processes

If you are using continuous integration on a repository with encrypted files,
you'll need to provide a way for the CI system to unlock them.  An easy, but
not _most_ secure way is to provide a _symmetric key_.  You can generate
this by running this in your project directory.

    git-crypt export-key git_crypt_key.key

`git_crypt_key.key` can now be used to decrypt the repository, and you can provide
it to the CI system as an environment variable.  However, since it is binary data,
you'll need to convert it to base64 first.  So run something like:

    cat git_crypt_key.key | base64 | pbcopy

to convert this file to base64 data, then paste it in your CI system's environment
variable field as something like `GIT_CRYPT_KEY64`.

To use the key later, you'll need (1) `git-crypt` and `gpg` installed in the CI
system image, and (2) to run these commands after the CI clones your repository:

    echo $GIT_ENCRYPT_KEY64 > git_crypt_key.key64 && base64 -d git_crypt_key.key64 > git_crypt_key.key && git-crypt unlock git_crypt_key.key
   
